# =============================================================================
# PRIVILEGED POD FOR NVMe MOUNT
# =============================================================================
# Use this as a fallback if the node user-data NVMe mount isn't working.
# This pod runs with privileged access to mount the NVMe device.
#
# Usage:
#   kubectl apply -f setup/02-mount-nvme-pod.yaml
#   kubectl logs nvme-mounter -f
#   kubectl delete pod nvme-mounter
#
# Note: This is a one-time operation. The mount persists after the pod exits.
# =============================================================================
apiVersion: v1
kind: Pod
metadata:
  name: nvme-mounter
  labels:
    app: nvme-mounter
spec:
  # Run on GPU nodes only
  nodeSelector:
    role: ai-gpu

  # Tolerate GPU taint
  tolerations:
    - key: "sku"
      operator: "Equal"
      value: "gpu"
      effect: "NoSchedule"

  # Run once and exit
  restartPolicy: Never

  # Need host access for mounting
  hostPID: true
  hostNetwork: true

  containers:
    - name: mounter
      image: amazonlinux:2
      securityContext:
        privileged: true
      command:
        - /bin/bash
        - -c
        - |
          set -ex

          echo "=== NVMe Mount Script ==="
          echo "Running on node: $(hostname)"

          NVME_DEVICE="${NVME_DEVICE:-/dev/nvme1n1}"
          MOUNT_POINT="${NVME_MOUNT_PATH:-/mnt/nvme}"
          MODELS_DIR="${MODELS_DIR:-/mnt/nvme/models}"

          echo "Device: $NVME_DEVICE"
          echo "Mount point: $MOUNT_POINT"

          # Check if already mounted
          if mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
              echo "Already mounted at $MOUNT_POINT"
              df -h "$MOUNT_POINT"
              exit 0
          fi

          # Detect NVMe device
          if [ ! -b "$NVME_DEVICE" ]; then
              echo "Configured device $NVME_DEVICE not found, searching..."
              for dev in /dev/nvme[0-9]n1; do
                  if [ -b "$dev" ]; then
                      # Skip root device
                      ROOT_DEV=$(findmnt -n -o SOURCE / | sed 's/p[0-9]*$//')
                      if [ "$dev" != "$ROOT_DEV" ] && [ "$dev" != "${ROOT_DEV}n1" ]; then
                          NVME_DEVICE="$dev"
                          echo "Found NVMe device: $NVME_DEVICE"
                          break
                      fi
                  fi
              done
          fi

          if [ ! -b "$NVME_DEVICE" ]; then
              echo "ERROR: No NVMe device found"
              lsblk
              exit 1
          fi

          # Format if needed
          if ! blkid "$NVME_DEVICE" | grep -q ext4; then
              echo "Formatting $NVME_DEVICE with ext4..."
              mkfs.ext4 -F "$NVME_DEVICE"
          else
              echo "Device already has ext4 filesystem"
          fi

          # Create mount point and mount
          mkdir -p "$MOUNT_POINT"
          mount "$NVME_DEVICE" "$MOUNT_POINT"

          # Create models directory
          mkdir -p "$MODELS_DIR"
          chmod 777 "$MODELS_DIR"

          echo ""
          echo "=== Mount successful ==="
          df -h "$MOUNT_POINT"
          ls -la "$MOUNT_POINT"

          echo ""
          echo "NVMe storage is ready at: $MOUNT_POINT"
          echo "Models directory: $MODELS_DIR"

      env:
        - name: NVME_DEVICE
          value: "/dev/nvme1n1"
        - name: NVME_MOUNT_PATH
          value: "/mnt/nvme"
        - name: MODELS_DIR
          value: "/mnt/nvme/models"

      volumeMounts:
        - name: host-root
          mountPath: /host
        - name: dev
          mountPath: /dev

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi

  volumes:
    - name: host-root
      hostPath:
        path: /
    - name: dev
      hostPath:
        path: /dev
