version: '3.8'

# ========================================================================
# LLM-JUDGE DOCKER COMPOSE
# ========================================================================
# Configuration values from .env file (copy from .env.example)
# Ports and settings should match deploy/iac/terragrunt/configuration.hcl
# ========================================================================

services:
  # Infrastructure Services
  redis:
    image: redis:7-alpine
    ports:
      - "${PORT_REDIS_CACHE:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: ${HEALTH_CHECK_RETRIES:-5}

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-llm_judge}
      MYSQL_USER: ${MYSQL_USER:-llm_judge}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    ports:
      - "${PORT_MYSQL:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: 10

  kafka:
    image: bitnami/kafka:3.7
    ports:
      - "${PORT_KAFKA:-9092}:9092"
    environment:
      KAFKA_CFG_NODE_ID: 0
      KAFKA_CFG_PROCESS_ROLES: broker,controller
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@kafka:9093
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka_data:/bitnami/kafka
    healthcheck:
      test: ["CMD", "kafka-topics.sh", "--bootstrap-server", "localhost:9092", "--list"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: 10

  # Base image build (other services depend on this)
  base-image:
    build:
      context: ..
      dockerfile: docker/Dockerfile.base
    image: llm-judge-base:latest

  # Application Services
  redis-service:
    build:
      context: ..
      dockerfile: ../src/services/redis/Dockerfile
    ports:
      - "${PORT_REDIS:-8001}:${PORT_REDIS:-8001}"
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-ap-south-1}
      APPCONFIG_APPLICATION_ID: ${APPCONFIG_APPLICATION_ID}
      APPCONFIG_ENVIRONMENT_ID: ${APPCONFIG_ENVIRONMENT_ID}
      APPCONFIG_PROFILE_ID: ${APPCONFIG_PROFILE_ID}
      SERVICE_PORT: ${PORT_REDIS:-8001}
    depends_on:
      base-image:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT_REDIS:-8001}${HEALTH_CHECK_PATH:-/health}"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: ${HEALTH_CHECK_RETRIES:-5}

  persistence-service:
    build:
      context: ..
      dockerfile: ../src/services/persistence/Dockerfile
    ports:
      - "${PORT_PERSISTENCE:-8002}:${PORT_PERSISTENCE:-8002}"
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-ap-south-1}
      APPCONFIG_APPLICATION_ID: ${APPCONFIG_APPLICATION_ID}
      APPCONFIG_ENVIRONMENT_ID: ${APPCONFIG_ENVIRONMENT_ID}
      APPCONFIG_PROFILE_ID: ${APPCONFIG_PROFILE_ID}
      SERVICE_PORT: ${PORT_PERSISTENCE:-8002}
    depends_on:
      base-image:
        condition: service_completed_successfully
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT_PERSISTENCE:-8002}${HEALTH_CHECK_PATH:-/health}"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: ${HEALTH_CHECK_RETRIES:-5}

  gateway-service:
    build:
      context: ..
      dockerfile: ../src/services/gateway/Dockerfile
    ports:
      - "${PORT_GATEWAY:-8000}:${PORT_GATEWAY:-8000}"
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-ap-south-1}
      APPCONFIG_APPLICATION_ID: ${APPCONFIG_APPLICATION_ID}
      APPCONFIG_ENVIRONMENT_ID: ${APPCONFIG_ENVIRONMENT_ID}
      APPCONFIG_PROFILE_ID: ${APPCONFIG_PROFILE_ID}
      SERVICE_PORT: ${PORT_GATEWAY:-8000}
    depends_on:
      base-image:
        condition: service_completed_successfully
      redis-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT_GATEWAY:-8000}${HEALTH_CHECK_PATH:-/health}"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: ${HEALTH_CHECK_RETRIES:-5}

  inference-service:
    build:
      context: ..
      dockerfile: ../src/services/inference/Dockerfile
    ports:
      - "${PORT_INFERENCE:-8003}:${PORT_INFERENCE:-8003}"
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-ap-south-1}
      APPCONFIG_APPLICATION_ID: ${APPCONFIG_APPLICATION_ID}
      APPCONFIG_ENVIRONMENT_ID: ${APPCONFIG_ENVIRONMENT_ID}
      APPCONFIG_PROFILE_ID: ${APPCONFIG_PROFILE_ID}
      SERVICE_PORT: ${PORT_INFERENCE:-8003}
    depends_on:
      base-image:
        condition: service_completed_successfully
      redis-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT_INFERENCE:-8003}${HEALTH_CHECK_PATH:-/health}"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: ${HEALTH_CHECK_RETRIES:-5}

  judge-service:
    build:
      context: ..
      dockerfile: ../src/services/judge/Dockerfile
    ports:
      - "${PORT_JUDGE:-8004}:${PORT_JUDGE:-8004}"
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-ap-south-1}
      APPCONFIG_APPLICATION_ID: ${APPCONFIG_APPLICATION_ID}
      APPCONFIG_ENVIRONMENT_ID: ${APPCONFIG_ENVIRONMENT_ID}
      APPCONFIG_PROFILE_ID: ${APPCONFIG_PROFILE_ID}
      SERVICE_PORT: ${PORT_JUDGE:-8004}
    depends_on:
      base-image:
        condition: service_completed_successfully
      redis-service:
        condition: service_healthy
      persistence-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT_JUDGE:-8004}${HEALTH_CHECK_PATH:-/health}"]
      interval: ${HEALTH_CHECK_INTERVAL:-10}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-5}s
      retries: ${HEALTH_CHECK_RETRIES:-5}

volumes:
  redis_data:
  mysql_data:
  kafka_data:
