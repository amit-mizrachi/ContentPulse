# LLM-Judge Architecture Diagram

## High-Level Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              AWS Cloud (us-east-1)                                          │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                        VPC (10.0.0.0/16)                                              │  │
│  │                                                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                              Public Subnets (10.0.1-3.0/24)                                     │  │  │
│  │  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                                         │  │  │
│  │  │   │  us-east-1a │    │  us-east-1b │    │  us-east-1c │                                         │  │  │
│  │  │   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                                         │  │  │
│  │  │          │                  │                  │                                                │  │  │
│  │  │          └────────────┬─────┴──────────────────┘                                                │  │  │
│  │  │                       │                                                                         │  │  │
│  │  │               ┌───────▼───────┐         ┌─────────────┐                                         │  │  │
│  │  │               │  Internet GW  │         │ NAT Instance│                                         │  │  │
│  │  │               │               │         │ (fck-nat)   │                                         │  │  │
│  │  │               │               │         │  t4g.nano   │                                         │  │  │
│  │  │               └───────┬───────┘         └──────┬──────┘                                         │  │  │
│  │  └───────────────────────┼────────────────────────┼────────────────────────────────────────────────┘  │  │
│  │                          │                        │                                                   │  │
│  │  ┌───────────────────────┼────────────────────────┼────────────────────────────────────────────────┐  │  │
│  │  │                       │   Private App Subnets (10.0.16-48.0/20)                                 │  │  │
│  │  │                       │                        │                                                │  │  │
│  │  │               ┌───────▼────────────────────────▼───────┐                                        │  │  │
│  │  │               │                                        │                                        │  │  │
│  │  │               │      Application Load Balancer         │◄──────── Internet Traffic              │  │  │
│  │  │               │         (AWS LB Controller)            │          (HTTPS :443)                  │  │  │
│  │  │               │                                        │                                        │  │  │
│  │  │               └───────────────────┬────────────────────┘                                        │  │  │
│  │  │                                   │                                                             │  │  │
│  │  │  ┌────────────────────────────────┼────────────────────────────────────────────────────────┐    │  │  │
│  │  │  │                                │                                                        │    │  │  │
│  │  │  │                    EKS Cluster (dev-llm-judge-cluster)                                  │    │  │  │
│  │  │  │                         Kubernetes v1.29                                                │    │  │  │
│  │  │  │                                                                                         │    │  │  │
│  │  │  │   ┌─────────────────────────────────────────────────────────────────────────────────┐   │    │  │  │
│  │  │  │   │                        Namespace: llm-judge                                     │   │    │  │  │
│  │  │  │   │                                                                                 │   │    │  │  │
│  │  │  │   │   ┌─────────────────┐                                                           │   │    │  │  │
│  │  │  │   │   │ Gateway Service │◄─────── ALB Ingress                                       │   │    │  │  │
│  │  │  │   │   │    :8000        │                                                           │   │    │  │  │
│  │  │  │   │   │   (FastAPI)     │                                                           │   │    │  │  │
│  │  │  │   │   └────────┬────────┘                                                           │   │    │  │  │
│  │  │  │   │            │                                                                    │   │    │  │  │
│  │  │  │   │            │ HTTP                      ┌─────────────────┐                      │   │    │  │  │
│  │  │  │   │            ├──────────────────────────►│  Redis Service  │                      │   │    │  │  │
│  │  │  │   │            │                           │     :8001       │                      │   │    │  │  │
│  │  │  │   │            │                           │  (HTTP Wrapper) │                      │   │    │  │  │
│  │  │  │   │            │                           └────────┬────────┘                      │   │    │  │  │
│  │  │  │   │            │                                    │                               │   │    │  │  │
│  │  │  │   │            │ SNS Publish                        │ Redis Protocol               │   │    │  │  │
│  │  │  │   │            ▼                                    ▼                               │   │    │  │  │
│  │  │  │   │   ┌─────────────────┐                  ┌─────────────────┐                      │   │    │  │  │
│  │  │  │   │   │Inference Service│◄─── SQS Poll     │Persistence Svc  │                      │   │    │  │  │
│  │  │  │   │   │    :8003        │                  │     :8002       │                      │   │    │  │  │
│  │  │  │   │   │   (FastAPI)     │                  │   (FastAPI)     │                      │   │    │  │  │
│  │  │  │   │   └────────┬────────┘                  └────────┬────────┘                      │   │    │  │  │
│  │  │  │   │            │                                    │                               │   │    │  │  │
│  │  │  │   │            │ SNS Publish                        │ MySQL Protocol               │   │    │  │  │
│  │  │  │   │            ▼                                    │                               │   │    │  │  │
│  │  │  │   │   ┌─────────────────┐                           │                               │   │    │  │  │
│  │  │  │   │   │  Judge Service  │───────────────────────────┘                               │   │    │  │  │
│  │  │  │   │   │    :8004        │◄─── SQS Poll                                              │   │    │  │  │
│  │  │  │   │   │   (FastAPI)     │                                                           │   │    │  │  │
│  │  │  │   │   └─────────────────┘                                                           │   │    │  │  │
│  │  │  │   │                                                                                 │   │    │  │  │
│  │  │  │   └─────────────────────────────────────────────────────────────────────────────────┘   │    │  │  │
│  │  │  │                                                                                         │    │  │  │
│  │  │  │   ┌─────────────────────────────────────────────────────────────────────────────────┐   │    │  │  │
│  │  │  │   │                     Namespace: kube-system                                      │   │    │  │  │
│  │  │  │   │   ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐           │   │    │  │  │
│  │  │  │   │   │  AWS LB      │ │   Cluster    │ │   Metrics    │ │   CoreDNS    │           │   │    │  │  │
│  │  │  │   │   │  Controller  │ │  Autoscaler  │ │   Server     │ │              │           │   │    │  │  │
│  │  │  │   │   └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘           │   │    │  │  │
│  │  │  │   └─────────────────────────────────────────────────────────────────────────────────┘   │    │  │  │
│  │  │  │                                                                                         │    │  │  │
│  │  │  │   ┌─────────────────────────────────────────────────────────────────────────────────┐   │    │  │  │
│  │  │  │   │                  Namespace: external-secrets-system                             │   │    │  │  │
│  │  │  │   │   ┌──────────────────────┐                                                      │   │    │  │  │
│  │  │  │   │   │  External Secrets    │────────► AWS Secrets Manager                         │   │    │  │  │
│  │  │  │   │   │     Operator         │                                                      │   │    │  │  │
│  │  │  │   │   └──────────────────────┘                                                      │   │    │  │  │
│  │  │  │   └─────────────────────────────────────────────────────────────────────────────────┘   │    │  │  │
│  │  │  │                                                                                         │    │  │  │
│  │  │  │   ┌──────────────────────────────────────────────────────────────────────────────────┐  │    │  │  │
│  │  │  │   │                           Node Groups                                            │  │    │  │  │
│  │  │  │   │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                      │  │    │  │  │
│  │  │  │   │  │    System      │  │  Application   │  │    AI/GPU      │                      │  │    │  │  │
│  │  │  │   │  │   t3.medium    │  │  m6i/m5 Spot   │  │  g4dn.xlarge   │                      │  │    │  │  │
│  │  │  │   │  │   On-Demand    │  │   2-10 nodes   │  │   0-1 (Spot)   │                      │  │    │  │  │
│  │  │  │   │  │   2-3 nodes    │  │                │  │   (disabled)   │                      │  │    │  │  │
│  │  │  │   │  └────────────────┘  └────────────────┘  └────────────────┘                      │  │    │  │  │
│  │  │  │   └──────────────────────────────────────────────────────────────────────────────────┘  │    │  │  │
│  │  │  │                                                                                         │    │  │  │
│  │  │  └─────────────────────────────────────────────────────────────────────────────────────────┘    │  │  │
│  │  │                                                                                                 │  │  │
│  │  └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                              Private Data Subnets (10.0.64-66.0/24)                             │  │  │
│  │  │                                                                                                 │  │  │
│  │  │   ┌────────────────────────────────┐        ┌────────────────────────────────┐                  │  │  │
│  │  │   │         RDS MySQL 8.0          │        │      ElastiCache Redis 7.1     │                  │  │  │
│  │  │   │     db.t4g.medium (Dev)        │        │      cache.t4g.medium (Dev)    │                  │  │  │
│  │  │   │     db.m6g.large (Prod)        │        │      cache.m6g.large (Prod)    │                  │  │  │
│  │  │   │                                │        │                                │                  │  │  │
│  │  │   │   - Database: llm_judge        │        │   - Port: 6379                 │                  │  │  │
│  │  │   │   - Port: 3306                 │        │   - TLS Enabled                │                  │  │  │
│  │  │   │   - Encrypted at rest          │        │   - At-rest encryption         │                  │  │  │
│  │  │   │   - Multi-AZ (Prod only)       │        │   - 7-day TTL for cache        │                  │  │  │
│  │  │   │   - IAM Auth enabled           │        │                                │                  │  │  │
│  │  │   └────────────────────────────────┘        └────────────────────────────────┘                  │  │  │
│  │  │                                                                                                 │  │  │
│  │  └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                                       │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │  │                                    VPC Endpoints                                               │   │  │
│  │  │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │   │  │
│  │  │   │   S3    │ │   SQS   │ │   SNS   │ │ Secrets │ │AppConfig│ │ECR API  │ │ECR DKR  │          │   │  │
│  │  │   │(Gateway)│ │(Interf.)│ │(Interf.)│ │ Manager │ │(Interf.)│ │(Interf.)│ │(Interf.)│          │   │  │
│  │  │   └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘          │   │  │
│  │  └────────────────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                                      AWS Managed Services                                           │    │
│  │                                                                                                     │    │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐ │    │
│  │  │        SNS          │  │        SQS          │  │   Secrets Manager   │  │     AppConfig       │ │    │
│  │  │                     │  │                     │  │                     │  │                     │ │    │
│  │  │ ┌─────────────────┐ │  │ ┌─────────────────┐ │  │ - RDS Credentials   │  │ - Runtime Config    │ │    │
│  │  │ │ inference-topic │ │  │ │ inference-queue │ │  │                     │  │ - SQS URLs          │ │    │
│  │  │ └─────────────────┘ │  │ │ + DLQ           │ │  │ (LLM API keys NOT   │  │ - SNS ARNs          │ │    │
│  │  │ ┌─────────────────┐ │  │ └─────────────────┘ │  │  stored - users     │  │ - Redis Config      │ │    │
│  │  │ │   judge-topic   │ │  │ ┌─────────────────┐ │  │  provide per-request│  │ - Service URLs      │ │    │
│  │  │ └─────────────────┘ │  │ │   judge-queue   │ │  │  via BYOK model)    │  │                     │ │    │
│  │  │                     │  │ │ + DLQ           │ │  │                     │  │                     │ │    │
│  │  │                     │  │ └─────────────────┘ │  │                     │  │                     │ │    │
│  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘ │    │
│  │                                                                                                     │    │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐                          │    │
│  │  │        ECR          │  │    IAM (IRSA)       │  │   Cost Management   │                          │    │
│  │  │                     │  │                     │  │                     │                          │    │
│  │  │ - gateway-service   │  │ - gateway-svc-role  │  │ - Budget Alerts     │                          │    │
│  │  │ - inference-service │  │ - inference-svc-role│  │   $50/$100/$150/$200│                          │    │
│  │  │ - judge-service     │  │ - judge-svc-role    │  │                     │                          │    │
│  │  │ - redis-service     │  │ - ext-secrets-role  │  │                     │                          │    │
│  │  │ - persistence-svc   │  │ - alb-ctrl-role     │  │                     │                          │    │
│  │  │ - ai-model-service  │  │ - autoscaler-role   │  │                     │                          │    │
│  │  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘                          │    │
│  │                                                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow Diagram

```
┌──────────────┐
│    Client    │
│   (HTTP)     │
└──────┬───────┘
       │
       │ HTTPS :443
       ▼
┌──────────────┐
│     ALB      │
│  (Internet   │
│   Facing)    │
└──────┬───────┘
       │
       │ HTTP :8000
       ▼
┌──────────────────────────────────────────────────────────────────────────────────────────┐
│                                    EKS Cluster                                           │
│                                                                                          │
│  ┌─────────────────┐         ┌─────────────────┐                                         │
│  │ Gateway Service │────────►│  Redis Service  │◄────────┐                               │
│  │     :8000       │  HTTP   │     :8001       │         │                               │
│  │                 │         │                 │         │                               │
│  │ 1. Receive req  │         │ Caches request  │         │                               │
│  │ 2. Generate UUID│         │ state & results │         │                               │
│  │ 3. Store state  │         │                 │         │                               │
│  │ 4. Publish SNS  │         └────────┬────────┘         │                               │
│  └────────┬────────┘                  │                  │                               │
│           │                           │ Redis            │                               │
│           │ SNS                       │ Protocol         │                               │
│           ▼                           ▼                  │                               │
│  ┌─────────────────┐         ┌─────────────────┐         │                               │
│  │ inference-topic │         │   ElastiCache   │         │                               │
│  │     (SNS)       │         │   Redis 7.1     │         │                               │
│  └────────┬────────┘         └─────────────────┘         │                               │
│           │                                              │                               │
│           │ Subscription                                 │                               │
│           ▼                                              │                               │
│  ┌─────────────────┐                                     │                               │
│  │ inference-queue │                                     │                               │
│  │     (SQS)       │                                     │                               │
│  └────────┬────────┘                                     │                               │
│           │                                              │                               │
│           │ Long Poll                                    │                               │
│           ▼                                              │                               │
│  ┌─────────────────┐                                     │                               │
│  │Inference Service│─────────────────────────────────────┘                               │
│  │     :8003       │  HTTP (state updates)                                               │
│  │                 │                                                                     │
│  │ 1. Poll SQS     │         ┌─────────────────┐                                         │
│  │ 2. Call OpenAI  │────────►│   OpenAI API    │                                         │
│  │ 3. Update state │         │  (External)     │                                         │
│  │ 4. Publish SNS  │         └─────────────────┘                                         │
│  └────────┬────────┘                                                                     │
│           │                                                                              │
│           │ SNS                                                                          │
│           ▼                                                                              │
│  ┌─────────────────┐                                                                     │
│  │   judge-topic   │                                                                     │
│  │     (SNS)       │                                                                     │
│  └────────┬────────┘                                                                     │
│           │                                                                              │
│           │ Subscription                                                                 │
│           ▼                                                                              │
│  ┌─────────────────┐                                                                     │
│  │   judge-queue   │                                                                     │
│  │     (SQS)       │                                                                     │
│  └────────┬────────┘                                                                     │
│           │                                                                              │
│           │ Long Poll                                                                    │
│           ▼                                                                              │
│  ┌─────────────────┐         ┌─────────────────┐                                         │
│  │  Judge Service  │────────►│   Google API    │                                         │
│  │     :8004       │         │   (External)    │                                         │
│  │                 │         └─────────────────┘                                         │
│  │ 1. Poll SQS     │                                                                     │
│  │ 2. Call Google  │         ┌─────────────────┐        ┌─────────────────┐              │
│  │ 3. Score resp   │────────►│Persistence Svc  │───────►│   RDS MySQL     │              │
│  │ 4. Persist      │  HTTP   │     :8002       │  SQL   │   (llm_judge)   │              │
│  │ 5. Update state │         └─────────────────┘        └─────────────────┘              │
│  └─────────────────┘                                                                     │
│                                                                                          │
└──────────────────────────────────────────────────────────────────────────────────────────┘
```

## Request State Machine

```
                    ┌─────────────────────────────────────────────────────────────┐
                    │                     Request Lifecycle                       │
                    └─────────────────────────────────────────────────────────────┘

     ┌──────────┐       ┌──────────┐       ┌──────────┐       ┌──────────┐       ┌──────────┐
     │          │       │          │       │          │       │          │       │          │
     │ CREATED  │──────►│ GATEWAY  │──────►│INFERENCE │──────►│  JUDGE   │──────►│COMPLETED │
     │          │       │          │       │          │       │          │       │          │
     └──────────┘       └──────────┘       └──────────┘       └──────────┘       └──────────┘
          │                  │                  │                  │                  │
          │                  │                  │                  │                  │
          ▼                  ▼                  ▼                  ▼                  ▼
     ┌─────────────────────────────────────────────────────────────────────────────────────┐
     │                              Redis (State Cache)                                    │
     │                                                                                     │
     │  Key: request:{uuid}                                                                │
     │  TTL: 7 days                                                                        │
     │                                                                                     │
     │  {                                                                                  │
     │    "request_id": "uuid",                                                            │
     │    "status": "COMPLETED",                                                           │
     │    "stage": "JUDGE",                                                                │
     │    "created_at": "2024-...",                                                        │
     │    "inference_result": { ... },                                                     │
     │    "judge_result": { "score": 0.85, ... }                                           │
     │  }                                                                                  │
     └─────────────────────────────────────────────────────────────────────────────────────┘
                                              │
                                              │ On COMPLETED
                                              ▼
     ┌─────────────────────────────────────────────────────────────────────────────────────┐
     │                              MySQL (Persistent Store)                               │
     │                                                                                     │
     │  Table: request_history                                                             │
     │  ┌────────────┬──────────┬─────────────────┬──────────────┬─────────────────────┐   │
     │  │ request_id │  status  │ inference_result│ judge_result │     created_at      │   │
     │  ├────────────┼──────────┼─────────────────┼──────────────┼─────────────────────┤   │
     │  │ uuid-1234  │COMPLETED │ { ... }         │ { score: 85 }│ 2024-01-01 12:00:00 │   │
     │  └────────────┴──────────┴─────────────────┴──────────────┴─────────────────────┘   │
     └─────────────────────────────────────────────────────────────────────────────────────┘
```

## Security & Network Policies

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              Network Policy Matrix                                      │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Source              Destination           Port      Protocol   Allowed               │
│   ─────────────────   ─────────────────     ────      ────────   ───────               │
│                                                                                         │
│   ALB                 gateway-service       8000      TCP        ✓                     │
│   gateway-service     redis-service         8001      TCP        ✓                     │
│   gateway-service     SNS (VPC Endpoint)    443       TCP        ✓                     │
│                                                                                         │
│   inference-service   redis-service         8001      TCP        ✓                     │
│   inference-service   SQS (VPC Endpoint)    443       TCP        ✓                     │
│   inference-service   SNS (VPC Endpoint)    443       TCP        ✓                     │
│   inference-service   OpenAI API            443       TCP        ✓ (via NAT)          │
│                                                                                         │
│   judge-service       redis-service         8001      TCP        ✓                     │
│   judge-service       persistence-service   8002      TCP        ✓                     │
│   judge-service       SQS (VPC Endpoint)    443       TCP        ✓                     │
│   judge-service       Google API            443       TCP        ✓ (via NAT)          │
│                                                                                         │
│   redis-service       ElastiCache           6379      TCP        ✓                     │
│   persistence-service RDS MySQL             3306      TCP        ✓                     │
│                                                                                         │
│   All Pods            DNS (CoreDNS)         53        UDP        ✓                     │
│   All Pods            AWS Services          443       TCP        ✓ (VPC Endpoints)    │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## Cost Optimization Features

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              Cost Optimization Summary                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Feature                          Savings vs Default          Monthly Savings (Est)   │
│   ────────────────────────────     ──────────────────          ────────────────────    │
│                                                                                         │
│   NAT Instance (fck-nat t4g.nano)  NAT Gateway ($32/mo)        ~$29/month              │
│   Spot Instances (App Nodes)       On-Demand pricing           ~40-60%                 │
│   Graviton Instances (ARM64)       x86 instances               ~20%                    │
│   VPC Endpoints                    NAT data transfer           ~$0.01/GB saved         │
│   GP3 Storage                      GP2 pricing                 ~20%                    │
│   ElastiCache t4g (Dev)            m6g instances               ~70% (dev only)         │
│   RDS t4g (Dev)                    m6g instances               ~70% (dev only)         │
│   GPU Nodes Scale to 0             Always-on GPU               ~$500+/month            │
│                                                                                         │
│   Budget Alerts: $50 / $100 / $150 / $200 thresholds                                   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## Terraform Module Dependencies

```
                                    ┌─────────────┐
                                    │    VPC      │
                                    │             │
                                    └──────┬──────┘
                                           │
                    ┌──────────────────────┼──────────────────────┐
                    │                      │                      │
                    ▼                      ▼                      ▼
           ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
           │security-groups│      │  iam-ec2-roles│      │      sns      │
           │               │      │               │      │               │
           └───────┬───────┘      └───────┬───────┘      └───────┬───────┘
                   │                      │                      │
        ┌──────────┼──────────┐           │                      │
        │          │          │           │                      │
        ▼          ▼          ▼           ▼                      ▼
   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐         ┌─────────┐
   │   rds   │ │elasticac│ │   eks   │ │   ec2   │         │   sqs   │
   │         │ │   he    │ │         │ │  (NAT)  │         │         │
   └────┬────┘ └────┬────┘ └────┬────┘ └─────────┘         └────┬────┘
        │          │           │                                │
        │          │           │                                │
        │          │           ▼                                │
        │          │    ┌─────────────┐                         │
        │          │    │  iam-roles  │◄────────────────────────┘
        │          │    │   (IRSA)    │
        │          │    └──────┬──────┘
        │          │           │
        └──────────┼───────────┘
                   │
                   ▼
            ┌─────────────┐
            │  appconfig  │
            │             │
            └─────────────┘

   ┌─────────┐  ┌─────────┐  ┌─────────┐
   │   ecr   │  │ secrets │  │ budgets │
   │         │  │         │  │         │
   └─────────┘  └─────────┘  └─────────┘
   (Independent - no dependencies)
```
